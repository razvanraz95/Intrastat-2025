<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Declarația Intrastat</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-color: #3c6382;
            --primary-light: #60a3bc;
            --primary-dark: #0a3d62;
            --accent-color: #f9ca24;
            --text-color: #2c3e50;
            --text-light: #7f8c8d;
            --bg-color: #f8f9fa;
            --box-bg: #ffffff;
            --box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08);
            --box-border: 1px solid rgba(0, 0, 0, 0.05);
            --transition: all 0.3s ease;
            --header-bg: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
        }

        .dark-mode {
            --primary-color: #0f4c75;
            --primary-light: #3282b8;
            --primary-dark: #1b262c;
            --accent-color: #f3a683;
            --text-color: #eeeeee;
            --text-light: #bbbbbb;
            --bg-color: #222831;
            --box-bg: #393e46;
            --box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            --box-border: 1px solid rgba(255, 255, 255, 0.05);
            --header-bg: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            transition: var(--transition);
            overflow-x: hidden;
        }

        header {
            background: var(--header-bg);
            color: white;
            padding: 30px 20px;
            text-align: center;
            position: relative;
            margin-bottom: 40px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        header h1 {
            font-family: 'Georgia', serif;
            font-size: 2.5rem;
            margin: 0;
            animation: fadeIn 1.5s ease-out;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .header-subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-top: 10px;
            animation: fadeIn 1.5s ease-out 0.5s both;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .theme-switch {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            z-index: 10;
        }

        .theme-switch label {
            margin: 0 10px;
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.3);
            transition: var(--transition);
            border-radius: 26px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: var(--transition);
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        input:checked + .slider {
            background-color: var(--accent-color);
        }

        input:checked + .slider:before {
            transform: translateX(24px);
        }

        .wave-container {
            height: 70px;
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            overflow: hidden;
        }

        .wave {
            background: url('data:image/svg+xml;utf8,<svg viewBox="0 0 1200 120" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="none"><path d="M0,0V46.29c47.79,22.2,103.59,32.17,158,28,70.36-5.37,136.33-33.31,206.8-37.5C438.64,32.43,512.34,53.67,583,72.05c69.27,18,138.3,24.88,209.4,13.08,36.15-6,69.85-17.84,104.45-29.34C989.49,25,1113-14.29,1200,52.47V0Z" fill="white" opacity=".25" /></svg>');
            background-size: cover;
            background-repeat: no-repeat;
            height: 120px;
            width: 100%;
            position: absolute;
            bottom: 0;
            animation: wave 8s linear infinite;
        }

        .wave:nth-child(2) {
            animation: wave 10s linear -2s infinite;
            opacity: 0.5;
        }

        @keyframes wave {
            0% {
                transform: translateX(0);
            }
            50% {
                transform: translateX(-50px);
            }
            100% {
                transform: translateX(0);
            }
        }

        .container {
            display: flex;
            flex-direction: column;
            gap: 30px;
            width: 90%;
            max-width: 1200px;
            margin: 0 auto 60px;
            animation: fadeUp 1s ease-out;
            z-index: 1;
        }

        @keyframes fadeUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .cards {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
        }

        .card {
            flex: 1;
            min-width: 300px;
            max-width: 500px;
            background-color: var(--box-bg);
            border-radius: 12px;
            padding: 25px;
            box-shadow: var(--box-shadow);
            border: var(--box-border);
            transition: var(--transition);
            animation: fadeUp 1s ease-out;
            position: relative;
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 25px rgba(0, 0, 0, 0.12);
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
        }

        .card:nth-child(1)::before {
            background-color: #00b894;
        }

        .card:nth-child(2)::before {
            background-color: #0984e3;
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            color: white;
            font-size: 1.2rem;
        }

        .card:nth-child(1) .card-icon {
            background-color: #00b894;
        }

        .card:nth-child(2) .card-icon {
            background-color: #0984e3;
        }

        .card h2 {
            font-size: 1.5rem;
            margin: 0;
            font-weight: 600;
        }

        .card-content {
            padding: 5px 0 20px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-color);
        }

        .file-upload {
            position: relative;
            display: block;
            border: 2px dashed rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            padding: 30px 20px;
            text-align: center;
            transition: var(--transition);
            cursor: pointer;
            background-color: rgba(0, 0, 0, 0.02);
        }

        .dark-mode .file-upload {
            border-color: rgba(255, 255, 255, 0.1);
            background-color: rgba(255, 255, 255, 0.05);
        }

        .file-upload:hover {
            border-color: var(--primary-light);
            background-color: rgba(0, 0, 0, 0.03);
        }

        .dark-mode .file-upload:hover {
            background-color: rgba(255, 255, 255, 0.08);
        }

        .file-upload i {
            font-size: 2.5rem;
            color: var(--primary-light);
            margin-bottom: 10px;
            display: block;
        }

        .file-upload p {
            margin: 10px 0 0;
            color: var(--text-light);
        }

        .file-upload input[type="file"] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-name {
            margin-top: 10px;
            font-size: 0.9rem;
            color: var(--text-light);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: none;
        }

        .file-name.active {
            display: block;
        }

        .button {
            display: inline-block;
            padding: 12px 24px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 1rem;
            transition: var(--transition);
            text-align: center;
            width: 100%;
            margin-top: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .button:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
        }

        .button:active {
            transform: translateY(0);
            box-shadow: 0 2px 3px rgba(0, 0, 0, 0.1);
        }

        .button.download {
            background-color: var(--accent-color);
            color: #333;
            display: none;
        }

        .button.download:hover {
            background-color: #f0b517;
        }

        .footer {
            margin-top: auto;
            background-color: var(--primary-dark);
            color: rgba(255, 255, 255, 0.7);
            text-align: center;
            padding: 20px;
            font-size: 0.9rem;
        }

        .footer a {
            color: rgba(255, 255, 255, 0.9);
            text-decoration: none;
            transition: var(--transition);
        }

        .footer a:hover {
            color: white;
            text-decoration: underline;
        }

        .info-section {
            max-width: 800px;
            margin: 0 auto 40px;
            background-color: var(--box-bg);
            border-radius: 12px;
            padding: 25px;
            box-shadow: var(--box-shadow);
            border: var(--box-border);
        }

        .info-section h2 {
            font-size: 1.5rem;
            margin-bottom: 15px;
            color: var(--primary-color);
            position: relative;
            padding-bottom: 10px;
        }

        .info-section h2::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 60px;
            height: 3px;
            background-color: var(--accent-color);
        }

        .info-section p {
            margin-bottom: 15px;
            line-height: 1.6;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            header h1 {
                font-size: 2rem;
            }
            
            .container {
                width: 95%;
            }
            
            .cards {
                flex-direction: column;
            }
            
            .card {
                max-width: 100%;
            }
            
            .theme-switch {
                top: 10px;
                right: 10px;
            }
        }

        /* Loading animation */
        .loader {
            display: none;
            width: 40px;
            height: 40px;
            margin: 20px auto;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid var(--primary-color);
            animation: spin 1s linear infinite;
        }

        .dark-mode .loader {
            border-color: rgba(255, 255, 255, 0.1);
            border-top-color: var(--primary-color);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <header>
        <div class="theme-switch">
            <label>Light</label>
            <label class="switch">
                <input type="checkbox" id="themeSwitch">
                <span class="slider"></span>
            </label>
            <label>Dark</label>
        </div>

        <h1>Declarația Intrastat</h1>
        <div class="header-subtitle">Generator de declarații XML pentru raportarea statistică Intrastat</div>
        
        <div class="wave-container">
            <div class="wave"></div>
            <div class="wave"></div>
        </div>
    </header>

    <div class="container">
        <div class="info-section">
            <h2>Despre aplicație</h2>
            <p>Această aplicație vă permite să generați declarații Intrastat în format XML din fișiere Excel. Sistemul validează datele și generează fișiere XML conforme cu cerințele Institutului Național de Statistică pentru raportarea Intrastat.</p>
            <p>Pentru a utiliza aplicația, încărcați un fișier Excel care conține foile "Date contact" și "Declaratie", apoi apăsați butonul de generare. Aplicația va valida datele și va genera un fișier XML gata de transmis.</p>
        </div>

        <div class="cards">
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-file-import"></i>
                    </div>
                    <h2>Introducere</h2>
                </div>
                <div class="card-content">
                    <div class="input-group">
                        <label>Încarcă fișierul Excel pentru introducere bunuri:</label>
                        <div class="file-upload">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <span>Selectează sau trage fișierul Excel aici</span>
                            <p>Format acceptat: .xlsx</p>
                            <input type="file" id="fileInput" accept=".xlsx">
                        </div>
                        <div id="fileName1" class="file-name"></div>
                    </div>
                    
                    <button class="button" id="generateButton" onclick="generateDeclaration()">Generează declarație</button>
                    <div id="loader1" class="loader"></div>
                    <button id="downloadButton" class="button download" onclick="downloadXML()">
                        <i class="fas fa-download"></i> Descarcă XML
                    </button>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-file-export"></i>
                    </div>
                    <h2>Expediere</h2>
                </div>
                <div class="card-content">
                    <div class="input-group">
                        <label>Încarcă fișierul Excel pentru expediere bunuri:</label>
                        <div class="file-upload">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <span>Selectează sau trage fișierul Excel aici</span>
                            <p>Format acceptat: .xlsx</p>
                            <input type="file" id="fileInputExpediere" accept=".xlsx">
                        </div>
                        <div id="fileName2" class="file-name"></div>
                    </div>
                    
                    <button class="button" id="generateButtonExpediere" onclick="generateDeclarationExpediere()">Generează declarație</button>
                    <div id="loader2" class="loader"></div>
                    <button id="downloadButtonExpediere" class="button download" onclick="downloadXMLExpediere()">
                        <i class="fas fa-download"></i> Descarcă XML
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        &copy; 2025 <a href="https://www.linkedin.com/in/razvanavasiloaia/" target="_blank">Razvan A.</a> | Generator Declarații Intrastat
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        let generatedDeclarationContent = "";
        let generatedDeclarationContentExpediere = "";

        document.addEventListener("DOMContentLoaded", function() {
            // Theme toggle
            const themeSwitch = document.getElementById('themeSwitch');
            
            // Check for saved theme preference or respect OS preference
            const prefersDarkScheme = window.matchMedia("(prefers-color-scheme: dark)");
            const storedTheme = localStorage.getItem("theme");
            
            if (storedTheme === "dark" || (!storedTheme && prefersDarkScheme.matches)) {
                document.body.classList.add("dark-mode");
                themeSwitch.checked = true;
            }
            
            themeSwitch.addEventListener('change', function() {
                if (this.checked) {
                    document.body.classList.add('dark-mode');
                    localStorage.setItem("theme", "dark");
                } else {
                    document.body.classList.remove('dark-mode');
                    localStorage.setItem("theme", "light");
                }
            });

            // File input display name
            const fileInput1 = document.getElementById('fileInput');
            const fileInput2 = document.getElementById('fileInputExpediere');
            const fileName1 = document.getElementById('fileName1');
            const fileName2 = document.getElementById('fileName2');
            
            fileInput1.addEventListener('change', function() {
                if (this.files.length > 0) {
                    fileName1.textContent = this.files[0].name;
                    fileName1.classList.add('active');
                } else {
                    fileName1.classList.remove('active');
                }
            });
            
            fileInput2.addEventListener('change', function() {
                if (this.files.length > 0) {
                    fileName2.textContent = this.files[0].name;
                    fileName2.classList.add('active');
                } else {
                    fileName2.classList.remove('active');
                }
            });
        });

        function generateDeclaration() {
            const fileInput = document.getElementById('fileInput');
            if (fileInput.files.length === 0) {
                Swal.fire({
                    icon: 'error',
                    title: 'Eroare',
                    text: 'Te rog selectează un fișier înainte de a genera declarația!',
                    confirmButtonColor: '#3c6382'
                });
                return;
            }
            
            // Show loader
            document.getElementById('loader1').style.display = 'block';
            document.getElementById('generateButton').disabled = true;
            
            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = function(event) {
                try {
                    const data = new Uint8Array(event.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    // Check if required sheets exist
                    if (!workbook.SheetNames.includes('Date contact') || !workbook.SheetNames.includes('Declaratie')) {
                        throw new Error("Fișierul trebuie să conțină foile 'Date contact' și 'Declaratie'");
                    }

                    const dateContactSheet = workbook.Sheets['Date contact'];
                    const declaratieSheet = workbook.Sheets['Declaratie'];

                    const dateContact = XLSX.utils.sheet_to_json(dateContactSheet, { header: 1 });
                    const declaratie = XLSX.utils.sheet_to_json(declaratieSheet, { header: 1 });

                    // Validate basic structure
                    if (dateContact.length < 2 || declaratie.length < 2) {
                        throw new Error("Foile de date nu conțin informații suficiente");
                    }

                    // Get required fields
                    const refPeriodStr = dateContact[1][8];
                    const currentDate = new Date();
                    const createDtStr = currentDate.toISOString();
                    const cui = dateContact[1][0].toString().padStart(10, '0');

                    // Generate XML header
                    let declaration = `<InsNewArrival xmlns="http://www.intrastat.ro/xml/InsSchema" SchemaVersion="1.0">
<InsCodeVersions>
<CountryVer>2022</CountryVer>
<EuCountryVer>2021</EuCountryVer>
<CnVer>2025</CnVer>
<ModeOfTransportVer>2005</ModeOfTransportVer>
<DeliveryTermsVer>2021</DeliveryTermsVer>
<NatureOfTransactionAVer>2022</NatureOfTransactionAVer>
<NatureOfTransactionBVer>2022</NatureOfTransactionBVer>
<CountyVer>1</CountyVer>
<LocalityVer>06/2006</LocalityVer>
<UnitVer>1</UnitVer>
</InsCodeVersions>
<InsDeclarationHeader>
<VatNr>${cui}</VatNr>
<FirmName>${dateContact[1][1]}</FirmName>
<RefPeriod>${refPeriodStr}</RefPeriod>
<CreateDt>${createDtStr}</CreateDt>
<ContactPerson>
<LastName>${dateContact[1][3]}</LastName>
<FirstName>${dateContact[1][4]}</FirstName>
<Email>${dateContact[1][6]}</Email>
<Phone>${dateContact[1][5]}</Phone>
<Fax>${dateContact[1][7]}</Fax>
<Position>${dateContact[1][2]}</Position>
</ContactPerson>
</InsDeclarationHeader>`;

                    let errors = [];
                    const validCountries = ["AT", "BE", "BG", "CZ", "CY", "HR", "DK", "EE", "FI", "FR", "DE", "GR", "IE", "XI", "IT", "LV", "LT", "LU", "MT", "PL", "PT", "SK", "SI", "ES", "SE", "NL", "HU", "QV"];
                    const validCountryOfOrigin = ["AF", "ZA", "AL", "DZ", "AD", "AO", "AI", "AQ", "AG", "SA", "AR", "AM", "AW", "AU", "AT", "AZ", "BS", "BH", "BD", "BB", "BY", "BE", "BZ", "BJ", "BM", "BT", "BQ", "BA", "BW", "BR", "BN", "BG", "BF", "BI", "KH", "CM", "CA", "CV", "CZ", "XC", "CL", "CN", "TD", "CY", "CI", "CO", "KM", "CG", "KP", "KR", "CR", "HR", "CU", "CW", "DK", "DJ", "DM", "EC", "EG", "CH", "AE", "ER", "EE", "SZ", "ET", "RU", "FJ", "PH", "FI", "FR", "GA", "GM", "GE", "GS", "DE", "GH", "GI", "GR", "GD", "GL", "GU", "GT", "GN", "GQ", "GW", "GY", "HT", "HN", "HK", "IN", "ID", "BV", "CX", "HM", "NF", "KY", "CC", "CK", "FK", "FO", "MP", "MH", "UM", "SB", "TC", "VI", "VG", "JO", "IQ", "IE", "IS", "IL", "IT", "JM", "JP", "KZ", "KG", "KE", "KI", "XK", "KW", "LS", "LV", "LB", "LR", "LY", "LI", "LT", "LU", "MO", "MK", "MG", "MY", "MW", "MV", "ML", "MT", "QP", "MA", "MR", "MU", "XL", "MX", "MN", "MS", "MZ", "ME", "MM", "NA", "NR", "NP", "NI", "NE", "NG", "NU", "NO", "NC", "NZ", "OM", "PK", "PW", "PA", "PG", "PY", "PE", "PN", "PF", "PL", "PT", "QA", "XU", "XI", "SY", "VE", "CF", "LA", "CD", "DO", "IR", "MD", "TZ", "RO", "RW", "EH", "KN", "LC", "VC", "BL", "PM", "SV", "WS", "AS", "SM", "ST", "SN", "XS", "SC", "SH", "VA", "SL", "SG", "SX", "SK", "SI", "SO", "ES", "LK", "FM", "US", "BO", "QS", "QR", "SD", "SS", "SE", "SR", "TJ", "TW", "TF", "PS", "IO", "TH", "TL", "TG", "TK", "TO", "TT", "TN", "TR", "TM", "TV", "QX", "QW", "QV", "NL", "UA", "UG", "HU", "UY", "UZ", "VU", "VN", "WF", "YE", "ZM", "ZW"];

                    // Process declaration items
                    for (let i = 1; i < declaratie.length; i++) {
                        if (declaratie[i].length > 0) {
                            const invoiceValue = parseFloat(declaratie[i][2]);
                            const statisticalValue = parseFloat(declaratie[i][3]);
                            const countryOfConsignment = declaratie[i][10];
                            const countryOfOrigin = declaratie[i][9];

                            let rowErrors = [];

                            if (invoiceValue < statisticalValue) {
                                rowErrors.push(`Valoarea facturii (${invoiceValue}) este mai mică decât valoarea statistică (${statisticalValue})`);
                            }
                            if (!validCountries.includes(countryOfConsignment)) {
                                rowErrors.push(`Țara de expediție (${countryOfConsignment}) nu este în lista țărilor valide`);
                            }
                        if (!validCountryOfOrigin.includes(countryOfOrigin)) {
                            rowErrors.push(`Country of Origin (${countryOfOrigin}) is not in the valid list`);
                        }

                        if (rowErrors.length > 0) {
                            errors.push(`Row ${i}: ${rowErrors.join('; ')}`);
                        } else {
                            declaration += `
<InsArrivalItem OrderNr="${declaratie[i][0]}">
<Cn8Code>${declaratie[i][1]}</Cn8Code>
<InvoiceValue>${invoiceValue}</InvoiceValue>
<StatisticalValue>${statisticalValue}</StatisticalValue>
<NetMass>${declaratie[i][4]}</NetMass>
<NatureOfTransactionACode>${declaratie[i][5]}</NatureOfTransactionACode>
<NatureOfTransactionBCode>${declaratie[i][6]}</NatureOfTransactionBCode>
<DeliveryTermsCode>${declaratie[i][7]}</DeliveryTermsCode>
<ModeOfTransportCode>${declaratie[i][8]}</ModeOfTransportCode>
<CountryOfOrigin>${countryOfOrigin}</CountryOfOrigin>`;

                            if (declaratie[i].length > 11 && declaratie[i][11] && declaratie[i][12]) {
                                declaration += `
<InsSupplUnitsInfo>
<SupplUnitCode>${declaratie[i][11]}</SupplUnitCode>
<QtyInSupplUnits>${declaratie[i][12]}</QtyInSupplUnits>
</InsSupplUnitsInfo>`;
                            }

                            declaration += `
<CountryOfConsignment>${countryOfConsignment}</CountryOfConsignment>
</InsArrivalItem>`;
                        }
                    }
                }

                if (errors.length > 0) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Eroare',
                        text: 'Au fost găsite erori:\n' + errors.join('\n'),
                        confirmButtonColor: '#3c6382'
                    });
                } else {
                    declaration += `
</InsNewArrival>`;

                    generatedDeclarationContent = declaration;
                    document.getElementById('downloadButton').style.display = 'block';
                }
                
                // Ascunde loaderul și reactivează butonul
                document.getElementById('loader1').style.display = 'none';
                document.getElementById('generateButton').disabled = false;
                
                } catch (error) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Eroare',
                        text: error.message,
                        confirmButtonColor: '#3c6382'
                    });
                    
                    // Ascunde loaderul și reactivează butonul
                    document.getElementById('loader1').style.display = 'none';
                    document.getElementById('generateButton').disabled = false;
                }
            };

            reader.readAsArrayBuffer(file);
        }

        function downloadXML() {
            const blob = new Blob([generatedDeclarationContent], { type: 'application/xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'declaration.xml';
            a.click();
            URL.revokeObjectURL(url);
        }

        function generateDeclarationExpediere() {
            const fileInput = document.getElementById('fileInputExpediere');
            if (fileInput.files.length === 0) {
                Swal.fire({
                    icon: 'error',
                    title: 'Eroare',
                    text: 'Te rog selectează un fișier înainte de a genera declarația!',
                    confirmButtonColor: '#3c6382'
                });
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = function(event) {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, { type: 'array' });

                const dateContactSheet = workbook.Sheets['Date contact'];
                const declaratieSheet = workbook.Sheets['Declaratie'];

                const dateContact = XLSX.utils.sheet_to_json(dateContactSheet, { header: 1 });
                const declaratie = XLSX.utils.sheet_to_json(declaratieSheet, { header: 1 });

                const refPeriodStr = dateContact[1][8];
                const currentDate = new Date();
                const createDtStr = currentDate.toISOString();

                const cui = dateContact[1][0].toString().padStart(10, '0');

                let declaration = `<InsNewDispatch xmlns="http://www.intrastat.ro/xml/InsSchema" SchemaVersion="1.0">
<InsCodeVersions>
<CountryVer>2022</CountryVer>
<EuCountryVer>2021</EuCountryVer>
<CnVer>2025</CnVer>
<ModeOfTransportVer>2005</ModeOfTransportVer>
<DeliveryTermsVer>2021</DeliveryTermsVer>
<NatureOfTransactionAVer>2022</NatureOfTransactionAVer>
<NatureOfTransactionBVer>2022</NatureOfTransactionBVer>
<CountyVer>1</CountyVer>
<LocalityVer>06/2006</LocalityVer>
<UnitVer>1</UnitVer>
</InsCodeVersions>
<InsDeclarationHeader>
<VatNr>${cui}</VatNr>
<FirmName>${dateContact[1][1]}</FirmName>
<RefPeriod>${refPeriodStr}</RefPeriod>
<CreateDt>${createDtStr}</CreateDt>
<ContactPerson>
<LastName>${dateContact[1][3]}</LastName>
<FirstName>${dateContact[1][4]}</FirstName>
<Email>${dateContact[1][6]}</Email>
<Phone>${dateContact[1][5]}</Phone>
<Fax>${dateContact[1][7]}</Fax>
<Position>${dateContact[1][2]}</Position>
</ContactPerson>
</InsDeclarationHeader>`;

                let errors = [];

                for (let i = 1; i < declaratie.length; i++) {
                    if (declaratie[i].length > 0) {
                        const invoiceValue = parseFloat(declaratie[i][2]);
                        const statisticalValue = parseFloat(declaratie[i][3]);
                        const countryOfDestination = declaratie[i][10];
                        const countryOfOrigin = declaratie[i][9];
                        const partnerCountryCode = declaratie[i][11];
                        const partnerVatNr = declaratie[i][12];

                        if (invoiceValue < statisticalValue) {
                            errors.push(`Row ${i}: Invoice Value (${invoiceValue}) is less than Statistical Value (${statisticalValue})`);
                        } else {
                            declaration += `
<InsDispatchItem OrderNr="${declaratie[i][0]}">
<Cn8Code>${declaratie[i][1]}</Cn8Code>
<InvoiceValue>${invoiceValue}</InvoiceValue>
<StatisticalValue>${statisticalValue}</StatisticalValue>
<NetMass>${declaratie[i][4]}</NetMass>
<NatureOfTransactionACode>${declaratie[i][5]}</NatureOfTransactionACode>
<NatureOfTransactionBCode>${declaratie[i][6]}</NatureOfTransactionBCode>
<DeliveryTermsCode>${declaratie[i][7]}</DeliveryTermsCode>
<ModeOfTransportCode>${declaratie[i][8]}</ModeOfTransportCode>
<CountryOfOrigin>${countryOfOrigin}</CountryOfOrigin>`;

                            if (declaratie[i].length > 13 && declaratie[i][13] && declaratie[i][14]) {
                                declaration += `
<InsSupplUnitsInfo>
<SupplUnitCode>${declaratie[i][13]}</SupplUnitCode>
<QtyInSupplUnits>${declaratie[i][14]}</QtyInSupplUnits>
</InsSupplUnitsInfo>`;
                            }

                            declaration += `
<CountryOfDestination>${countryOfDestination}</CountryOfDestination>
<PartnerCountryCode>${partnerCountryCode}</PartnerCountryCode>
<PartnerVatNr>${partnerVatNr}</PartnerVatNr>
</InsDispatchItem>`;
                        }
                    }
                }

                if (errors.length > 0) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Eroare',
                        text: 'Au fost găsite erori:\n' + errors.join('\n'),
                    });
                } else {
                    declaration += `
</InsNewDispatch>`;

                    generatedDeclarationContentExpediere = declaration;
                    document.getElementById('downloadButtonExpediere').style.display = 'block';
                }
            };

            reader.readAsArrayBuffer(file);
        }

        function downloadXMLExpediere() {
            const blob = new Blob([generatedDeclarationContentExpediere], { type: 'application/xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'declaration.xml';
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>                     